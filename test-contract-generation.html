<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Contract Generation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .error { background: #fee; border-color: #c00; }
        .success { background: #efe; border-color: #0c0; }
        .info { background: #eef; border-color: #00c; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <h1>üîç Contract Generation Diagnostic Tool</h1>
    
    <div class="section info">
        <h2>Step 1: Check Libraries</h2>
        <button onclick="checkLibraries()">Check Libraries</button>
        <div id="libraryStatus"></div>
    </div>
    
    <div class="section info">
        <h2>Step 2: Check Template File</h2>
        <button onclick="checkTemplate()">Check Template File</button>
        <div id="templateStatus"></div>
    </div>
    
    <div class="section info">
        <h2>Step 3: Test with Minimal Data</h2>
        <button onclick="testMinimal()">Test Minimal Generation</button>
        <div id="minimalStatus"></div>
    </div>
    
    <div class="section info">
        <h2>Console Output</h2>
        <pre id="consoleOutput"></pre>
    </div>

    <!-- Libraries (Local copies) -->
    <script src="pizzip.js"></script>
    <script src="docxtemplater.js"></script>

    <script>
        let consoleLog = [];
        
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            consoleLog.push('[LOG] ' + args.join(' '));
            updateConsole();
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            consoleLog.push('[ERROR] ' + args.join(' '));
            updateConsole();
            originalError.apply(console, args);
        };
        
        function updateConsole() {
            document.getElementById('consoleOutput').textContent = consoleLog.join('\n');
        }
        
        function checkLibraries() {
            const status = document.getElementById('libraryStatus');
            let html = '<h3>Library Status:</h3>';
            
            html += '<p>PizZip: ' + (typeof PizZip !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded') + '</p>';
            html += '<p>Docxtemplater: ' + (typeof Docxtemplater !== 'undefined' || typeof docxtemplater !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded') + '</p>';
            
            if (typeof PizZip !== 'undefined') {
                html += '<p>PizZip version: ' + (PizZip.version || 'Unknown') + '</p>';
            }
            
            status.innerHTML = html;
            status.className = 'section ' + (typeof PizZip !== 'undefined' && (typeof Docxtemplater !== 'undefined' || typeof docxtemplater !== 'undefined') ? 'success' : 'error');
        }
        
        async function checkTemplate() {
            const status = document.getElementById('templateStatus');
            status.innerHTML = '<p>Checking template file...</p>';
            
            try {
                const response = await fetch('ND FALL 2026 - CONTRACT - 9 Jan 2026 - 11 May 2026 (1).docx');
                
                if (!response.ok) {
                    status.innerHTML = '<p class="error">‚ùå Template file not found!</p>';
                    status.className = 'section error';
                    return;
                }
                
                const buffer = await response.arrayBuffer();
                status.innerHTML = `<p>‚úÖ Template file found!</p><p>Size: ${buffer.byteLength} bytes</p>`;
                status.className = 'section success';
                
            } catch (error) {
                status.innerHTML = `<p class="error">‚ùå Error loading template: ${error.message}</p>`;
                status.className = 'section error';
            }
        }
        
        async function testMinimal() {
            const status = document.getElementById('minimalStatus');
            status.innerHTML = '<p>Testing with minimal data...</p>';
            
            try {
                console.log('=== Starting Minimal Test ===');
                
                // Load template
                const response = await fetch('ND FALL 2026 - CONTRACT - 9 Jan 2026 - 11 May 2026 (1).docx');
                if (!response.ok) throw new Error('Template not found');
                
                const templateBuffer = await response.arrayBuffer();
                console.log('Template loaded:', templateBuffer.byteLength, 'bytes');
                
                // Create minimal test data with ALL possible fields
                const testData = {
                    // Required fields
                    contract_date: '2025-11-25',
                    owner_apt_number: 'RR#407',
                    owner_name: 'Test Owner',
                    tenant_address_line1: '123 Test St',
                    tenant_address_line2: 'Test City, TS 12345',
                    tenant_phone: '+1234567890',
                    tenant_email: 'test@test.com',
                    lease_start_date: '2026-01-09',
                    lease_end_date: '2026-05-11',
                    total_nights: '122',
                    apt1_number: 'RR#407',
                    apt1_address: 'Test Address',
                    apt1_bedrooms: '2',
                    apt1_bathrooms: '1',
                    apt1_students: '2',
                    total_students: '2',
                    total_apartments: '1',
                    rent_per_student_per_night: '80.00',
                    rent_series: '122',
                    total_rent: '19520',
                    payment_method: 'Bank Transfer',
                    payment_due_date: '2026-01-01',
                    security_deposit_per_tenant: '500.00',
                    security_deposit_total: '1000.00',
                    security_deposit_text: 'Five Hundred EURO (‚Ç¨500.00) PER TENANT',
                    deposit_return_days: '60',
                    electricity_rate_per_m2: '0.50',
                    gas_rate_per_m2: '1.48',
                    utility_payment_days: '44',
                    wifi_provided: 'Yes - Included',
                    wifi_info: 'WiFi included',
                    cleaning_included: 'Yes - Included',
                    cleaning_info: 'Cleaning included',
                    emergency_contact_name: 'Emergency Contact',
                    emergency_contact_phone: '+1234567890',
                    emergency_contact_relation: 'Friend',
                    tenant_rep_name: 'Test Representative',
                    tenant_rep_organization: 'Test Organization',
                    
                    // Optional fields - all set to empty string
                    owner_apt_number_2: '',
                    owner_name_2: '',
                    tenant_organization: '',
                    tenant_additional_info: '',
                    apt2_number: '',
                    apt2_address: '',
                    apt2_bedrooms: '',
                    apt2_bathrooms: '',
                    apt2_students: '',
                    apt3_number: '',
                    apt3_address: '',
                    apt3_bedrooms: '',
                    apt3_bathrooms: '',
                    apt3_students: '',
                    wifi_cost: '',
                    cleaning_cost: '',
                    pets_allowed: false,
                    smoking_allowed: false,
                    quiet_hours: '',
                    additional_rules: '',
                    additional_signature_1_name: '',
                    additional_signature_1_org: '',
                    additional_signature_2_name: '',
                    additional_signature_2_org: ''
                };
                
                console.log('Test data prepared with', Object.keys(testData).length, 'fields');
                
                // Load with PizZip
                const zip = new PizZip(templateBuffer);
                console.log('PizZip created');
                
                // Create Docxtemplater
                const DocxTemplater = typeof Docxtemplater !== 'undefined' ? Docxtemplater : docxtemplater;
                const doc = new DocxTemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });
                console.log('Docxtemplater created');
                
                // Set data
                doc.setData(testData);
                console.log('Data set');
                
                // Render
                doc.render();
                console.log('Document rendered successfully!');
                
                // Generate blob
                const blob = doc.getZip().generate({
                    type: 'blob',
                    mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                });
                
                // Download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'test-contract.docx';
                a.click();
                URL.revokeObjectURL(url);
                
                status.innerHTML = '<p class="success">‚úÖ Test successful! Contract downloaded as test-contract.docx</p>';
                status.className = 'section success';
                
            } catch (error) {
                console.error('Test failed:', error);
                console.error('Error stack:', error.stack);
                
                let errorHtml = `<p class="error">‚ùå Test failed: ${error.message}</p>`;
                
                if (error.properties && error.properties.errors) {
                    errorHtml += '<h4>Specific errors:</h4><ul>';
                    error.properties.errors.forEach(err => {
                        errorHtml += `<li>${err.message}`;
                        if (err.properties && err.properties.id) {
                            errorHtml += ` (Field: ${err.properties.id})`;
                        }
                        errorHtml += '</li>';
                    });
                    errorHtml += '</ul>';
                }
                
                status.innerHTML = errorHtml;
                status.className = 'section error';
            }
        }
        
        // Auto-check on load
        window.onload = function() {
            checkLibraries();
        };
    </script>
</body>
</html>

