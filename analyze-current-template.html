<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze Current Template</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .section {
            background: white;
            padding: 25px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
        }
        .success { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; }
        .warning { background: #fff3cd; border-left: 4px solid #ff9800; padding: 15px; margin: 15px 0; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; margin: 15px 0; }
        #content {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        .highlight { background: yellow; color: black; padding: 2px 4px; font-weight: bold; }
        .good { background: #51cf66; color: black; padding: 2px 4px; font-weight: bold; }
        .bad { background: #ff6b6b; color: white; padding: 2px 4px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Analyze Current Word Template</h1>
        <p>Automatic analysis of: ND FALL 2026 - CONTRACT - 9 Jan 2026 - 11 May 2026 (1).docx</p>
    </div>

    <div class="section">
        <button onclick="analyzeTemplate()">üîç Analyze Template Now</button>
    </div>

    <div class="section" id="resultsSection" style="display: none;">
        <h2>üìä Analysis Results</h2>
        <div id="summary"></div>
        <h3>üìÑ Template Content (with highlighted merge fields):</h3>
        <div id="content"></div>
    </div>

    <script src="https://unpkg.com/pizzip@3.1.6/dist/pizzip.js"></script>
    
    <script>
        async function analyzeTemplate() {
            const summary = document.getElementById('summary');
            const content = document.getElementById('content');
            const resultsSection = document.getElementById('resultsSection');

            try {
                summary.innerHTML = '<p>‚è≥ Loading template...</p>';
                resultsSection.style.display = 'block';

                // Load template with cache busting
                const response = await fetch('ND FALL 2026 - CONTRACT - 9 Jan 2026 - 11 May 2026 (1).docx?t=' + Date.now(), {
                    cache: 'no-store'
                });

                if (!response.ok) throw new Error('Template not found!');

                const buffer = await response.arrayBuffer();
                const zip = new PizZip(buffer);
                const xml = zip.file('word/document.xml').asText();

                // Extract text
                const matches = xml.match(/<w:t[^>]*>([^<]+)<\/w:t>/g);
                if (!matches) throw new Error('Could not extract text');

                const fullText = matches.map(m => m.replace(/<w:t[^>]*>([^<]+)<\/w:t>/, '$1')).join(' ');

                // Find merge fields
                const mergeFields = fullText.match(/\{[a-z_0-9]+\}/gi) || [];
                const unique = [...new Set(mergeFields)];

                // Expected fields based on client requirements
                const expected = {
                    'Contract Date': ['{contract_date}'],
                    'Owner Info': ['{owner_apt_number}', '{owner_name}', '{owner_apt_number_2}', '{owner_name_2}'],
                    'Tenant Info': ['{tenant_organization}', '{tenant_address_line1}', '{tenant_address_line2}', '{tenant_phone}', '{tenant_email}'],
                    'Lease Details': ['{lease_start_date}', '{lease_end_date}', '{total_nights}'],
                    'Property': ['{property_address}'],
                    'Payment': ['{rent_per_night}', '{total_rent}']
                };

                // Fields that should NOT be there
                const forbidden = ['{landlord_name}', '{landlord_address_usa}', '{landlord_address_italy}', '{landlord_phone}', '{landlord_email}'];

                // Analyze
                let allExpected = [];
                Object.values(expected).forEach(arr => allExpected.push(...arr));

                const found = unique.filter(f => allExpected.includes(f.toLowerCase()));
                const missing = allExpected.filter(f => !unique.map(u => u.toLowerCase()).includes(f.toLowerCase()));
                const wrong = unique.filter(f => forbidden.includes(f.toLowerCase()));
                const unknown = unique.filter(f => !allExpected.includes(f.toLowerCase()) && !forbidden.includes(f.toLowerCase()));

                // Build summary
                let html = `<div class="info"><h3>üìã Template File Info</h3><p>Size: ${buffer.byteLength} bytes</p><p>Total merge fields: ${unique.length}</p></div>`;

                if (found.length > 0) {
                    html += `<div class="success"><h3>‚úÖ Found ${found.length} Correct Fields:</h3><ul>`;
                    Object.entries(expected).forEach(([category, fields]) => {
                        const categoryFound = fields.filter(f => unique.map(u => u.toLowerCase()).includes(f.toLowerCase()));
                        if (categoryFound.length > 0) {
                            html += `<li><strong>${category}:</strong> ${categoryFound.join(', ')}</li>`;
                        }
                    });
                    html += `</ul></div>`;
                }

                if (missing.length > 0) {
                    html += `<div class="warning"><h3>‚ö†Ô∏è Missing ${missing.length} Expected Fields:</h3><ul>`;
                    Object.entries(expected).forEach(([category, fields]) => {
                        const categoryMissing = fields.filter(f => !unique.map(u => u.toLowerCase()).includes(f.toLowerCase()));
                        if (categoryMissing.length > 0) {
                            html += `<li><strong>${category}:</strong> ${categoryMissing.join(', ')}</li>`;
                        }
                    });
                    html += `</ul><p><strong>‚ö†Ô∏è You need to ADD these to your Word template!</strong></p></div>`;
                }

                if (wrong.length > 0) {
                    html += `<div class="error"><h3>‚ùå Found ${wrong.length} Fields That Should Be REMOVED:</h3><ul>`;
                    wrong.forEach(f => html += `<li>${f}</li>`);
                    html += `</ul><p><strong>‚ùå These should be static text, not merge fields!</strong></p></div>`;
                }

                if (unknown.length > 0) {
                    html += `<div class="info"><h3>‚ÑπÔ∏è Other Fields Found (${unknown.length}):</h3><ul>`;
                    unknown.forEach(f => html += `<li>${f}</li>`);
                    html += `</ul></div>`;
                }

                summary.innerHTML = html;

                // Highlight merge fields in content
                let highlighted = fullText.substring(0, 5000);
                unique.forEach(field => {
                    const isGood = found.includes(field);
                    const isBad = wrong.includes(field);
                    const className = isBad ? 'bad' : (isGood ? 'good' : 'highlight');
                    const regex = new RegExp(field.replace(/[{}]/g, '\\$&'), 'g');
                    highlighted = highlighted.replace(regex, `<span class="${className}">${field}</span>`);
                });

                content.innerHTML = highlighted + '\n\n... (showing first 5000 characters)\n\n' +
                    '<span class="good">GREEN</span> = Correct fields ‚úÖ\n' +
                    '<span class="bad">RED</span> = Should be removed ‚ùå\n' +
                    '<span class="highlight">YELLOW</span> = Other fields';

            } catch (error) {
                summary.innerHTML = `<div class="error"><h3>‚ùå Error</h3><p>${error.message}</p></div>`;
                content.textContent = error.stack;
            }
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            setTimeout(analyzeTemplate, 500);
        });
    </script>
</body>
</html>

